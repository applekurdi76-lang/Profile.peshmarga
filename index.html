<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فیرقەی (٩) - انزیبات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap');
        body { font-family: 'Vazirmatn', sans-serif; background-color: #f8fafc; }
        .list-item { transition: all 0.2s; border-right: 5px solid transparent; }
        .list-item:hover { border-right-color: #ef4444; background-color: #ffffff; transform: translateX(-5px); }
        .profile-grid div { background: #f1f5f9; padding: 12px; border-radius: 15px; }
        .label { font-size: 11px; color: #64748b; font-weight: bold; display: block; }
        .value { font-size: 14px; color: #1e293b; font-weight: 900; }
        .hidden { display: none !important; }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="bg-slate-900 text-white p-5 shadow-lg border-b-4 border-red-600 flex justify-between items-center shrink-0">
        <div>
            <h1 class="text-xl font-black">فیرقەی (٩)ی پیادە</h1>
            <p class="text-[10px] text-red-500 font-bold uppercase tracking-widest">انزیباتی عەسکەری</p>
        </div>
        
        <div class="flex gap-2">
            <button id="manageFieldsBtn" onclick="openFieldsModal()" class="hidden bg-blue-600 hover:bg-blue-700 w-12 h-12 rounded-2xl shadow-lg transition flex items-center justify-center">
                <i class="fas fa-cog text-xl"></i>
            </button>
            <button id="addBtn" onclick="openForm()" class="hidden bg-red-600 hover:bg-red-700 w-12 h-12 rounded-2xl shadow-lg transition flex items-center justify-center">
                <i class="fas fa-plus text-xl"></i>
            </button>
            <button id="loginBtn" onclick="openLogin()" class="bg-slate-700 hover:bg-slate-800 w-12 h-12 rounded-2xl shadow-lg transition flex items-center justify-center">
                <i class="fas fa-lock text-xl"></i>
            </button>
        </div>
    </header>

    <div class="p-4 bg-white border-b shrink-0">
        <div class="relative max-w-2xl mx-auto">
            <input type="text" id="search" onkeyup="filterList()" placeholder="گەڕان بەدوای ناو یان دۆسیە..." class="w-full p-4 pr-12 rounded-2xl bg-slate-100 border-none focus:ring-2 focus:ring-red-500 outline-none font-bold">
            <i class="fas fa-search absolute right-4 top-5 text-slate-400"></i>
        </div>
    </div>

    <main class="flex-1 overflow-y-auto p-4 custom-scroll" id="mainList">
        <p class="text-center text-slate-400 mt-10">چاوەڕێبە، داتاکان باردەکرێن...</p>
    </main>

    <div id="profileModal" class="fixed inset-0 bg-slate-900/90 hidden z-50 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl rounded-[40px] overflow-hidden shadow-2xl max-h-[90vh] flex flex-col">
            <div class="p-6 overflow-y-auto custom-scroll" id="profileContent"></div>
            <div class="p-4 bg-slate-50 border-t flex flex-col gap-3">
                <div id="adminActionBox" class="flex gap-3 hidden">
                    <button id="editBtn" class="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-black">دەستکاریکردن</button>
                    <button id="deleteBtn" class="flex-1 py-4 bg-red-100 text-red-600 rounded-2xl font-black">سڕینەوە</button>
                </div>
                <button onclick="closeModal('profileModal')" class="w-full py-4 bg-slate-200 text-slate-700 rounded-2xl font-black">داخستن</button>
            </div>
        </div>
    </div>

    <div id="formModal" class="fixed inset-0 bg-slate-900/95 hidden z-[60] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl rounded-[40px] p-8 max-h-[90vh] overflow-y-auto custom-scroll">
            <h3 class="text-2xl font-black mb-6 border-b pb-4">تۆمارکردنی دۆسیە</h3>
            <div class="flex flex-col items-center mb-6 w-full px-4">
                <div id="prevBox" class="w-28 h-28 bg-slate-100 rounded-[30px] border-2 border-dashed flex items-center justify-center overflow-hidden mb-2">
                    <i class="fas fa-camera text-slate-300"></i>
                </div>
                <input type="text" id="fImageUrl" placeholder="لینکی وێنە (URL)" class="w-full max-w-sm p-3 bg-slate-50 border rounded-xl text-center font-bold text-sm" oninput="handleImgUrl(this.value)" dir="ltr">
            </div>
            <input type="hidden" id="fId">
            <div id="dynamicInputs" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                </div>
            <div class="mt-4">
                <textarea id="fNote" placeholder="تێبینی گشتی" class="w-full p-3 bg-slate-50 border rounded-xl"></textarea>
            </div>
            <div id="loadingStatus" class="hidden text-center text-red-600 font-bold mt-4">خەریکی خەزنکردنە...</div>
            <div class="flex gap-3 mt-8">
                <button onclick="save()" class="flex-1 py-4 bg-red-600 text-white rounded-2xl font-black shadow-lg">پاشەکەوت</button>
                <button onclick="closeModal('formModal')" class="flex-1 py-4 bg-slate-100 rounded-2xl font-bold">پاشگەزبوونەوە</button>
            </div>
        </div>
    </div>

    <div id="fieldsModal" class="fixed inset-0 bg-slate-900/95 hidden z-[80] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[30px] p-6 shadow-2xl">
            <h3 class="text-xl font-black mb-4">ڕێکخستنی خانەکان</h3>
            <div id="fieldsList" class="space-y-2 max-h-64 overflow-y-auto mb-4 p-2 bg-slate-50 rounded-xl"></div>
            <div class="flex flex-col gap-2">
                <input type="text" id="newFieldName" placeholder="ناوی خانەی نوێ (بۆ نموونە: جۆری خوێن)" class="p-3 bg-slate-100 border rounded-xl">
                <button onclick="addField()" class="bg-blue-600 text-white py-2 rounded-xl font-bold">+ زیادکردنی خانە</button>
            </div>
            <button onclick="closeModal('fieldsModal')" class="w-full mt-4 py-3 bg-slate-200 rounded-xl font-bold">تەواو</button>
        </div>
    </div>

    <div id="loginModal" class="fixed inset-0 bg-slate-900/95 hidden z-[70] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[30px] p-8 shadow-2xl text-center">
            <h3 class="text-xl font-black mb-6 text-slate-800">چوونە ژوورەوەی ئەدمین</h3>
            <input type="password" id="adminPass" placeholder="وشەی نهێنی..." class="w-full p-4 bg-slate-50 border rounded-xl text-center font-bold mb-4" dir="ltr">
            <div id="loginError" class="hidden text-xs text-red-500 font-bold mb-4">وشەی نهێنی هەڵەیە!</div>
            <div class="flex gap-2">
                <button id="loginSubmitBtn" onclick="checkLogin()" class="flex-1 py-3 bg-slate-800 text-white rounded-xl font-bold">چوونە ژوورەوە</button>
                <button onclick="closeModal('loginModal')" class="py-3 px-4 bg-slate-100 rounded-xl">داخستن</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAgz9dbzedRoyuhbg5lApgCtKF-jZxSozI",
            authDomain: "srya-inzibat.firebaseapp.com",
            projectId: "srya-inzibat",
            storageBucket: "srya-inzibat.firebasestorage.app",
            messagingSenderId: "919615770372",
            appId: "1:919615770372:web:2462d0d7e81cb8eae58a51"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const sariyaCollection = collection(db, "SariyaListDB");

        window.localDb = [];
        window.fieldsConfig = [];
        window.isAdmin = false;
        window.tempImg = "";

        // --- Core Functions ---

        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.openLogin = () => document.getElementById('loginModal').classList.remove('hidden');

        // Load Fields from Firebase
        async function loadFields() {
            const docSnap = await getDoc(doc(db, "Admin", "FieldsConfig"));
            if (docSnap.exists()) {
                window.fieldsConfig = docSnap.data().list;
            } else {
                window.fieldsConfig = [
                    { id: "fName", label: "ناوی سیانی", key: "name", fullWidth: true },
                    { id: "fRank", label: "پلە", key: "rank" },
                    { id: "fFile", label: "ژمارەی دۆسیە", key: "file" }
                ];
                await setDoc(doc(db, "Admin", "FieldsConfig"), { list: window.fieldsConfig });
            }
            renderInputs();
        }

        function renderInputs() {
            const container = document.getElementById('dynamicInputs');
            container.innerHTML = "";
            window.fieldsConfig.forEach(f => {
                const div = document.createElement('div');
                if(f.fullWidth) div.className = "md:col-span-2";
                div.innerHTML = `<label class="text-[10px] font-bold text-slate-400 mr-2">${f.label}</label>
                                 <input type="text" id="${f.id}" class="w-full p-3 bg-slate-50 border rounded-xl font-bold">`;
                container.appendChild(div);
            });
        }

        window.checkLogin = async function() {
            const pass = document.getElementById('adminPass').value;
            const docSnap = await getDoc(doc(db, "Admin", "Settings"));
            const realPass = docSnap.exists() ? docSnap.data().password : "12345";

            if(pass === realPass) {
                window.isAdmin = true;
                document.getElementById('loginBtn').classList.add('hidden');
                document.getElementById('addBtn').classList.remove('hidden');
                document.getElementById('manageFieldsBtn').classList.remove('hidden');
                closeModal('loginModal');
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        };

        window.save = async function() {
            if(!window.isAdmin) return;
            document.getElementById('loadingStatus').classList.remove('hidden');
            const data = { img: window.tempImg, note: document.getElementById('fNote').value };
            
            window.fieldsConfig.forEach(f => {
                data[f.key] = document.getElementById(f.id).value;
            });

            try {
                const id = document.getElementById('fId').value;
                id ? await updateDoc(doc(db, "SariyaListDB", id), data) : await addDoc(sariyaCollection, data);
                closeModal('formModal');
                fetchAndRenderList();
            } catch (e) { alert("هەڵەیەک ڕوویدا!"); }
            document.getElementById('loadingStatus').classList.add('hidden');
        };

        window.fetchAndRenderList = async function() {
            const snap = await getDocs(sariyaCollection);
            window.localDb = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            filterList();
        };

        window.filterList = function() {
            const q = document.getElementById('search').value.toLowerCase();
            const list = document.getElementById('mainList');
            const filtered = window.localDb.filter(p => p.name?.toLowerCase().includes(q) || p.file?.includes(q));
            
            list.innerHTML = filtered.map(p => `
                <div onclick="showProfile('${p.id}')" class="list-item bg-white p-4 rounded-2xl mb-3 shadow-sm flex items-center gap-4 cursor-pointer">
                    <div class="w-14 h-14 rounded-xl overflow-hidden bg-slate-100 border">
                        <img src="${p.img || ''}" class="w-full h-full object-cover" onerror="this.src='https://ui-avatars.com/api/?name=${p.name}'">
                    </div>
                    <div class="flex-1">
                        <h3 class="font-black text-slate-800">${p.name}</h3>
                        <p class="text-xs text-red-500 font-bold">${p.rank || ''} | دۆسیە: ${p.file || ''}</p>
                    </div>
                </div>
            `).join('');
        };

        window.showProfile = function(id) {
            const p = window.localDb.find(x => x.id === id);
            const gridHtml = window.fieldsConfig.map(f => `
                <div class="${f.fullWidth ? 'col-span-2' : ''}">
                    <span class="label">${f.label}</span>
                    <span class="value">${p[f.key] || '---'}</span>
                </div>
            `).join('');

            document.getElementById('profileContent').innerHTML = `
                <div class="flex flex-col items-center mb-8">
                    <img src="${p.img || ''}" class="w-32 h-32 rounded-[40px] shadow-xl object-cover mb-4" onerror="this.style.display='none'">
                    <h2 class="text-2xl font-black text-slate-800">${p.name}</h2>
                </div>
                <div class="profile-grid grid grid-cols-2 gap-3">${gridHtml}</div>
                <div class="mt-4 p-3 bg-red-50 rounded-xl"><span class="label">تێبینی</span><p class="value">${p.note || 'نییە'}</p></div>
            `;
            
            document.getElementById('adminActionBox').classList.toggle('hidden', !window.isAdmin);
            document.getElementById('editBtn').onclick = () => editP(p);
            document.getElementById('deleteBtn').onclick = () => deleteP(p.id);
            document.getElementById('profileModal').classList.remove('hidden');
        };

        window.editP = (p) => {
            closeModal('profileModal');
            document.getElementById('formModal').classList.remove('hidden');
            document.getElementById('fId').value = p.id;
            document.getElementById('fNote').value = p.note || "";
            window.handleImgUrl(p.img || "");
            window.fieldsConfig.forEach(f => {
                document.getElementById(f.id).value = p[f.key] || "";
            });
        };

        window.deleteP = async (id) => {
            if(confirm("ئایا دڵنیای لە سڕینەوە؟")) {
                await deleteDoc(doc(db, "SariyaListDB", id));
                closeModal('profileModal');
                fetchAndRenderList();
            }
        };

        // --- Field Management ---
        window.openFieldsModal = () => {
            const list = document.getElementById('fieldsList');
            list.innerHTML = window.fieldsConfig.map((f, index) => `
                <div class="flex justify-between items-center bg-white p-2 rounded-lg shadow-sm">
                    <span class="font-bold text-sm">${f.label}</span>
                    <button onclick="removeField(${index})" class="text-red-500"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
            document.getElementById('fieldsModal').classList.remove('hidden');
        };

        window.addField = async () => {
            const name = document.getElementById('newFieldName').value;
            if(!name) return;
            const key = "k_" + Date.now();
            window.fieldsConfig.push({ id: "f"+key, label: name, key: key });
            await setDoc(doc(db, "Admin", "FieldsConfig"), { list: window.fieldsConfig });
            document.getElementById('newFieldName').value = "";
            renderInputs();
            openFieldsModal();
        };

        window.removeField = async (index) => {
            window.fieldsConfig.splice(index, 1);
            await setDoc(doc(db, "Admin", "FieldsConfig"), { list: window.fieldsConfig });
            renderInputs();
            openFieldsModal();
        };

        window.handleImgUrl = (url) => {
            window.tempImg = url;
            document.getElementById('prevBox').innerHTML = url ? `<img src="${url}" class="w-full h-full object-cover">` : `<i class="fas fa-camera text-slate-300"></i>`;
            document.getElementById('fImageUrl').value = url;
        };

        window.openForm = () => {
            document.getElementById('fId').value = "";
            document.querySelectorAll('#formModal input, #formModal textarea').forEach(i => i.value = "");
            window.handleImgUrl("");
            document.getElementById('formModal').classList.remove('hidden');
        };

        // Initialize
        loadFields();
        fetchAndRenderList();

    </script>
</body>
</html>
